#include <stdio.h>
#include <math.h>
#include <string.h>
#include <stdlib.h>
#include <assert.h>

#include "fast_tri.h"

// https://zh.wikipedia.org/wiki/%E6%B3%B0%E5%8B%92%E7%BA%A7%E6%95%B0
// https://stackoverflow.com/posts/9073675/revisions

#define sign(x) ((x >= 0)? 1 : -1)
#define abs(x) ((x > 0)? (x) : -(x))

#ifdef DEB
#define logf(x) printf(#x ":%.6f ", x)
#define logfn(x) printf(#x ":%.6f\n", x)
#define logd(x) printf(#x ":%d ", x)
#define logdn(x) printf(#x ":%d\n", x)
#define log(fmt, x...) printf("%s %d " fmt, __func__,__LINE__, ##x) 
#else
#define logf(x)
#define logfn(x)
#define logd(x)
#define logdn(x)
#define log(fmt, x...)
#endif

#define fastsmall (0.05f)

//const static float fastpi2 = 3.14159265358f * 3.14159265358f;

static inline int mod(int a, int b)
{
    return a - ((a/b)*b);
}

/* should be power of 2 */
static inline int mod2(int a, int b)
{
    return a & (b - 1);
}

static inline int fast_fmod2(float x, float m, int q, float *ax)
{
    float _x = x / m;
    int _ix = _x;
    *ax = (_x - _ix) * m;
    return mod2(_ix, q);
}

static inline float max(float x, float y)
{
    return (x > y)? x: y;
}
static inline float min(float x, float y)
{
    return (x < y)? x: y;
}
static inline float absf(float x)
{
    return (x < 0)? -x: x;
}

static float quadInterpolation(
    float a0[2], float a1[2], float a2[2], float f)
{
    float af0x = f - a0[0];
    float af1x = f - a1[0];
    float af2x = f - a2[0];
    float a01x = a0[0] - a1[0];
    float a02x = a0[0] - a2[0];
    float a12x = a1[0] - a2[0];
    float t0 = af1x / a02x;
    float t1 = af2x / a01x;
    float t2 = af0x / a12x;
    return t1 * (a0[1] * t0 - a1[1] * t2) + a2[1] * t2 * t0;
}

static inline float lerp(float a, float b, float x)
{
    return a * x + b;   
}

static inline float bilinear(float a, float b, float w)
{
    return a + w * (b - a);
}

#define cubic(ax, b, a0, a1, a2) ((b) + (ax) * ((a0) + (ax) * ((a1) + (ax) * (a2)))) 
#define quad(ax, b, a0, a1) ((b) + (ax) * ((a0) + (ax) * (a1)))

#define cubicArr(ax, a) ((a[0]) + (ax) * ((a[1]) + (ax) * ((a[2]) + (ax) * (a[3])))) 
#define quadArr(ax, a) ((a[0]) + (ax) * ((a[1]) + (ax) * (a[2])))

float fast_asin2(float x)
{
    static const float asin_thr_s = 0.05f;
    static const float asin_thr_m = 0.65f;
    static const float asin_thr_h = 0.9f;
    static const float asin_lkt[] =
    {
        1.11976951, 1.11999899, 1.12022856, 1.12045825, 1.12068805,
       1.12091796, 1.12114797, 1.1213781 , 1.12160833, 1.12183868,
       1.12206913, 1.1222997 , 1.12253038, 1.12276116, 1.12299206,
       1.12322307, 1.12345419, 1.12368542, 1.12391677, 1.12414822,
       1.12437979, 1.12461147, 1.12484326, 1.12507516, 1.12530718,
       1.12553931, 1.12577155, 1.12600391, 1.12623637, 1.12646896,
       1.12670165, 1.12693446, 1.12716739, 1.12740042, 1.12763358,
       1.12786684, 1.12810022, 1.12833372, 1.12856733, 1.12880106,
       1.1290349 , 1.12926886, 1.12950293, 1.12973713, 1.12997143,
       1.13020585, 1.13044039, 1.13067505, 1.13090982, 1.13114471,
       1.13137972, 1.13161485, 1.13185009, 1.13208545, 1.13232093,
       1.13255653, 1.13279224, 1.13302808, 1.13326403, 1.1335001 ,
       1.1337363 , 1.13397261, 1.13420904, 1.13444559, 1.13468226,
       1.13491905, 1.13515596, 1.13539299, 1.13563015, 1.13586742,
       1.13610482, 1.13634233, 1.13657997, 1.13681773, 1.13705561,
       1.13729362, 1.13753175, 1.13777   , 1.13800837, 1.13824686,
       1.13848548, 1.13872422, 1.13896309, 1.13920208, 1.13944119,
       1.13968043, 1.13991979, 1.14015928, 1.14039889, 1.14063863,
       1.14087849, 1.14111848, 1.1413586 , 1.14159884, 1.1418392 ,
       1.1420797 , 1.14232031, 1.14256106, 1.14280193, 1.14304293,
       1.14328406, 1.14352532, 1.1437667 , 1.14400821, 1.14424985,
       1.14449162, 1.14473352, 1.14497554, 1.1452177 , 1.14545998,
       1.1457024 , 1.14594494, 1.14618762, 1.14643042, 1.14667336,
       1.14691642, 1.14715962, 1.14740295, 1.14764641, 1.14789   ,
       1.14813372, 1.14837758, 1.14862157, 1.14886569, 1.14910994,
       1.14935433, 1.14959884, 1.1498435 , 1.15008828, 1.15033321,
       1.15057826, 1.15082345, 1.15106877, 1.15131423, 1.15155983,
       1.15180556, 1.15205142, 1.15229743, 1.15254356, 1.15278984,
       1.15303625, 1.15328279, 1.15352948, 1.1537763 , 1.15402326,
       1.15427036, 1.15451759, 1.15476497, 1.15501248, 1.15526013,
       1.15550792, 1.15575585, 1.15600392, 1.15625213, 1.15650048,
       1.15674897, 1.1569976 , 1.15724637, 1.15749528, 1.15774433,
       1.15799353, 1.15824286, 1.15849234, 1.15874196, 1.15899173,
       1.15924163, 1.15949168, 1.15974188, 1.15999222, 1.1602427 ,
       1.16049332, 1.16074409, 1.16099501, 1.16124607, 1.16149727,
       1.16174862, 1.16200012, 1.16225176, 1.16250355, 1.16275548,
       1.16300756, 1.16325979, 1.16351217, 1.1637647 , 1.16401737,
       1.16427019, 1.16452316, 1.16477628, 1.16502954, 1.16528296,
       1.16553653, 1.16579024, 1.16604411, 1.16629813, 1.16655229,
       1.16680661, 1.16706108, 1.16731571, 1.16757048, 1.16782541,
       1.16808049, 1.16833572, 1.1685911 , 1.16884664, 1.16910233,
       1.16935818, 1.16961418, 1.16987033, 1.17012664, 1.17038311,
       1.17063973, 1.1708965 , 1.17115344, 1.17141052, 1.17166777,
       1.17192517, 1.17218273, 1.17244045, 1.17269832, 1.17295636,
       1.17321455, 1.1734729 , 1.17373141, 1.17399008, 1.17424891,
       1.1745079 , 1.17476705, 1.17502636, 1.17528583, 1.17554546,
       1.17580526, 1.17606521, 1.17632533, 1.17658561, 1.17684606,
       1.17710666, 1.17736743, 1.17762837, 1.17788947, 1.17815073,
       1.17841216, 1.17867376, 1.17893552, 1.17919744, 1.17945953,
       1.17972179, 1.17998422, 1.18024681, 1.18050957, 1.1807725 ,
       1.18103559, 1.18129886, 1.18156229, 1.1818259 , 1.18208967,
       1.18235361, 1.18261773, 1.18288201, 1.18314646, 1.18341109,
       1.18367589, 1.18394086, 1.184206  , 1.18447132, 1.18473681,
       1.18500247, 1.1852683 , 1.18553432, 1.1858005 , 1.18606686,
       1.1863334 , 1.18660011, 1.18686699, 1.18713406, 1.1874013 ,
       1.18766871, 1.18793631, 1.18820408, 1.18847203, 1.18874016,
       1.18900847, 1.18927696, 1.18954563, 1.18981448, 1.19008351,
       1.19035272, 1.19062211, 1.19089168, 1.19116144, 1.19143137,
       1.19170149, 1.1919718 , 1.19224228, 1.19251296, 1.19278381,
       1.19305485, 1.19332608, 1.19359749, 1.19386909, 1.19414087,
       1.19441284, 1.194685  , 1.19495735, 1.19522988, 1.19550261,
       1.19577552, 1.19604862, 1.19632191, 1.19659539, 1.19686906,
       1.19714292, 1.19741698, 1.19769122, 1.19796566, 1.19824029,
       1.19851512, 1.19879014, 1.19906535, 1.19934075, 1.19961635,
       1.19989215, 1.20016814, 1.20044433, 1.20072071, 1.2009973 ,
       1.20127407, 1.20155105, 1.20182823, 1.2021056 , 1.20238317,
       1.20266095, 1.20293892, 1.20321709, 1.20349547, 1.20377405,
       1.20405283, 1.20433181, 1.20461099, 1.20489038, 1.20516997,
       1.20544976, 1.20572977, 1.20600997, 1.20629038, 1.206571  ,
       1.20685182, 1.20713286, 1.2074141 , 1.20769554, 1.2079772 ,
       1.20825906, 1.20854114, 1.20882342, 1.20910592, 1.20938863,
       1.20967154, 1.20995468, 1.21023802, 1.21052157, 1.21080534,
       1.21108933, 1.21137353, 1.21165794, 1.21194257, 1.21222741,
       1.21251248, 1.21279775, 1.21308325, 1.21336897, 1.2136549 ,
       1.21394105, 1.21422743, 1.21451402, 1.21480083, 1.21508787,
       1.21537513, 1.2156626 , 1.21595031, 1.21623823, 1.21652638,
       1.21681476, 1.21710336, 1.21739219, 1.21768124, 1.21797052,
       1.21826002, 1.21854976, 1.21883972, 1.21912992, 1.21942034,
       1.21971099, 1.22000187, 1.22029299, 1.22058433, 1.22087591,
       1.22116773, 1.22145977, 1.22175205, 1.22204457, 1.22233732,
       1.22263031, 1.22292353, 1.22321699, 1.22351069, 1.22380463,
       1.2240988 , 1.22439322, 1.22468788, 1.22498277, 1.22527791,
       1.22557329, 1.22586892, 1.22616478, 1.2264609 , 1.22675725,
       1.22705385, 1.2273507 , 1.2276478 , 1.22794514, 1.22824273,
       1.22854056, 1.22883865, 1.22913699, 1.22943558, 1.22973441,
       1.2300335 , 1.23033285, 1.23063244, 1.23093229, 1.2312324 ,
       1.23153276, 1.23183337, 1.23213424, 1.23243537, 1.23273676,
       1.23303841, 1.23334031, 1.23364248, 1.2339449 , 1.23424759,
       1.23455054, 1.23485375, 1.23515723, 1.23546097, 1.23576497,
       1.23606924, 1.23637378, 1.23667858, 1.23698365, 1.23728899,
       1.2375946 , 1.23790048, 1.23820663, 1.23851306, 1.23881975,
       1.23912672, 1.23943396, 1.23974148, 1.24004927, 1.24035733,
       1.24066568, 1.2409743 , 1.2412832 , 1.24159238, 1.24190184,
       1.24221158, 1.24252161, 1.24283191, 1.2431425 , 1.24345337,
       1.24376453, 1.24407597, 1.2443877 , 1.24469972, 1.24501202,
       1.24532462, 1.2456375 , 1.24595068, 1.24626414, 1.2465779 ,
       1.24689195, 1.2472063 , 1.24752094, 1.24783587, 1.24815111,
       1.24846664, 1.24878246, 1.24909859, 1.24941502, 1.24973175,
       1.25004878, 1.25036612, 1.25068375, 1.25100169, 1.25131994,
       1.2516385 , 1.25195736, 1.25227653, 1.25259601, 1.2529158 ,
       1.2532359 , 1.25355631, 1.25387704, 1.25419807, 1.25451943,
       1.2548411 , 1.25516309, 1.25548539, 1.25580801, 1.25613096,
       1.25645422, 1.25677781, 1.25710172, 1.25742595, 1.25775051,
       1.25807539, 1.2584006 , 1.25872614, 1.259052  , 1.2593782 ,
       1.25970473, 1.26003158, 1.26035878, 1.2606863 , 1.26101416,
       1.26134236, 1.26167089, 1.26199977, 1.26232898, 1.26265853,
       1.26298843, 1.26331866, 1.26364924, 1.26398017, 1.26431144,
       1.26464306, 1.26497503, 1.26530734, 1.26564001, 1.26597303,
       1.2663064 , 1.26664013, 1.26697421, 1.26730864, 1.26764344,
       1.26797859, 1.2683141 , 1.26864998, 1.26898622, 1.26932282,
       1.26965978, 1.26999711, 1.27033481, 1.27067288, 1.27101131,
       1.27135012, 1.2716893 , 1.27202885, 1.27236878, 1.27270909,
       1.27304977, 1.27339083, 1.27373227, 1.27407409, 1.27441629,
       1.27475888, 1.27510185, 1.27544521, 1.27578896, 1.2761331 ,
       1.27647762, 1.27682254, 1.27716785, 1.27751356, 1.27785967,
       1.27820617, 1.27855307, 1.27890037, 1.27924807, 1.27959618,
       1.27994469, 1.2802936 , 1.28064293, 1.28099266, 1.28134281,
       1.28169336, 1.28204434, 1.28239572, 1.28274752, 1.28309974,
       1.28345238, 1.28380545, 1.28415893, 1.28451284, 1.28486717,
       1.28522194, 1.28557713, 1.28593275, 1.2862888 , 1.28664529,
       1.28700222, 1.28735958, 1.28771738, 1.28807562, 1.28843431,
       1.28879343, 1.28915301, 1.28951303, 1.2898735 , 1.29023442,
       1.29059579, 1.29095762, 1.2913199 , 1.29168265, 1.29204585,
       1.29240951, 1.29277364, 1.29313823, 1.29350329, 1.29386881,
       1.29423481, 1.29460128, 1.29496823, 1.29533565, 1.29570355,
       1.29607193, 1.29644079, 1.29681014, 1.29717997, 1.29755029,
       1.2979211 , 1.2982924 , 1.2986642 , 1.29903649, 1.29940928,
       1.29978257, 1.30015636, 1.30053066, 1.30090546, 1.30128077,
       1.30165659, 1.30203293, 1.30240978, 1.30278715, 1.30316503,
       1.30354344, 1.30392237, 1.30430183, 1.30468181, 1.30506233,
       1.30544338, 1.30582496, 1.30620708, 1.30658974, 1.30697295,
       1.30735669, 1.30774099, 1.30812583, 1.30851122, 1.30889717,
       1.30928368, 1.30967074, 1.31005837, 1.31044656, 1.31083531,
       1.31122464, 1.31161453, 1.31200501, 1.31239605, 1.31278768,
       1.31317989, 1.31357268, 1.31396606, 1.31436004, 1.3147546 ,
       1.31514976, 1.31554552, 1.31594188, 1.31633884, 1.31673641,
       1.31713459, 1.31753338, 1.31793279, 1.31833282, 1.31873346,
       1.31913474, 1.31953663, 1.31993916, 1.32034232, 1.32074612,
       1.32115056, 1.32155564, 1.32196137, 1.32236774, 1.32277477,
       1.32318245, 1.32359079, 1.3239998 , 1.32440946, 1.3248198 ,
       1.32523081, 1.32564249, 1.32605485, 1.3264679 , 1.32688163,
       1.32729605, 1.32771116, 1.32812696, 1.32854347, 1.32896068,
       1.32937859, 1.32979722, 1.33021656, 1.33063662, 1.3310574 ,
       1.33147891, 1.33190114, 1.33232411, 1.33274782, 1.33317227,
       1.33359746, 1.3340234 , 1.3344501 , 1.33487755, 1.33530576,
       1.33573474, 1.33616449, 1.33659501, 1.33702632, 1.3374584 ,
       1.33789127, 1.33832493, 1.33875939, 1.33919465, 1.33963071,
       1.34006759, 1.34050527, 1.34094378, 1.34138311, 1.34182326,
       1.34226425, 1.34270608, 1.34314875, 1.34359227, 1.34403664,
       1.34448186, 1.34492795, 1.34537491, 1.34582274, 1.34627145,
       1.34672104, 1.34717152, 1.3476229 , 1.34807517, 1.34852835,
       1.34898244, 1.34943744, 1.34989337, 1.35035023, 1.35080802,
       1.35126674, 1.35172642, 1.35218704, 1.35264862, 1.35311116,
       1.35357468, 1.35403916, 1.35450463, 1.35497109, 1.35543855,
       1.355907  , 1.35637646, 1.35684694, 1.35731843, 1.35779096,
       1.35826452, 1.35873912, 1.35921477, 1.35969147, 1.36016924,
       1.36064808, 1.36112799, 1.36160899, 1.36209108, 1.36257428,
       1.36305858, 1.36354399, 1.36403053, 1.3645182 , 1.36500701,
       1.36549696, 1.36598807, 1.36648035, 1.3669738 , 1.36746843,
       1.36796424, 1.36846126, 1.36895948, 1.36945892, 1.36995959,
       1.37046148, 1.37096463, 1.37146902, 1.37197468, 1.37248161,
       1.37298982, 1.37349933, 1.37401013, 1.37452225, 1.37503569,
       1.37555046, 1.37606658, 1.37658405, 1.37710289, 1.3776231 ,
       1.3781447 , 1.3786677 , 1.3791921 , 1.37971793, 1.3802452 ,
       1.3807739 , 1.38130407, 1.3818357 , 1.38236882, 1.38290343,
       1.38343955, 1.38397719, 1.38451636, 1.38505708, 1.38559936,
       1.38614321, 1.38668866, 1.3872357 , 1.38778436, 1.38833465,
       1.38888659, 1.38944019, 1.38999547, 1.39055244, 1.39111111,
       1.39167151, 1.39223365, 1.39279755, 1.39336322, 1.39393067,
       1.39449994, 1.39507103, 1.39564396, 1.39621876, 1.39679543,
       1.39737401, 1.3979545 , 1.39853692, 1.3991213 , 1.39970766,
       1.40029602, 1.40088639, 1.4014788 , 1.40207327, 1.40266983,
       1.40326848, 1.40386927, 1.4044722 , 1.40507731, 1.40568461,
       1.40629414, 1.40690591, 1.40751996, 1.4081363 , 1.40875496,
       1.40937598, 1.40999937, 1.41062517, 1.4112534 , 1.41188409,
       1.41251728, 1.41315298, 1.41379124, 1.41443209, 1.41507555,
       1.41572165, 1.41637044, 1.41702195, 1.4176762 , 1.41833324,
       1.4189931 , 1.41965582, 1.42032144, 1.42098999, 1.42166152,
       1.42233606, 1.42301365, 1.42369435, 1.42437818, 1.42506521,
       1.42575546, 1.42644899, 1.42714585, 1.42784607, 1.42854973,
       1.42925685, 1.42996751, 1.43068174, 1.43139961, 1.43212117,
       1.43284648, 1.4335756 , 1.43430859, 1.43504552, 1.43578644,
       1.43653142, 1.43728054, 1.43803385, 1.43879145, 1.43955338,
       1.44031975, 1.44109061, 1.44186606, 1.44264617, 1.44343104,
       1.44422074, 1.44501538, 1.44581504, 1.44661982, 1.44742983,
       1.44824516, 1.44906593, 1.44989224, 1.45072421, 1.45156196,
       1.4524056 , 1.45325527, 1.4541111 , 1.45497323, 1.45584179,
       1.45671693, 1.45759881, 1.45848759, 1.45938343, 1.46028649,
       1.46119697, 1.46211504, 1.46304091, 1.46397476, 1.46491682,
       1.46586731, 1.46682646, 1.4677945 , 1.46877169, 1.46975831,
       1.47075461, 1.47176091, 1.4727775 , 1.47380472, 1.47484289,
       1.47589239, 1.47695358, 1.47802688, 1.4791127 , 1.48021151,
       1.48132377, 1.48244999, 1.48359072, 1.48474653, 1.48591804,
       1.4871059 , 1.48831083, 1.48953359, 1.49077498, 1.49203589,
       1.49331728, 1.49462018, 1.49594571, 1.49729509, 1.49866967,
       1.50007091, 1.50150043, 1.50296002, 1.50445166, 1.50597757,
       1.50754023, 1.50914242, 1.51078732, 1.51247854, 1.51422024,
       1.51601722, 1.51787513, 1.51980061, 1.52180163, 1.52388787,
       1.52607124, 1.52836674, 1.53079366, 1.53337757, 1.53615358,
       1.53917223, 1.54251111, 1.54630082, 1.55079599, 1.55665407,
       1.57079633
    };
    static const float asin_coef[2][4] =
    {
        {
            -0.0005908687721839501,
            1.01623692,
            -0.09276421,
            0.31582311
        },
        {
            -1.4890572852055513,
            7.37297766,
            -9.1981949,
            4.69627441
        }
    };

    float signa = sign(x);
    float ax = abs(x);
    if (ax > 1) {
        printf("Error ax %f\n", ax);
        assert(ax <= 1);
    }
    if (ax < asin_thr_s) return x;
    else if (ax < asin_thr_m) return signa * cubicArr(ax, asin_coef[0]);
    else if (ax < asin_thr_h) return signa * cubicArr(ax, asin_coef[1]);
    else {
        #if 0
        float ax_up = ax * 10000.0f;
        int ax_f = ax_up;
        int idx = ax_f - 9000;
        if (idx == 0) return signa * 1.11976951;
        else if (idx == 1000) return signa * fastpi_2;
        float fidx = ax_up - ax_f ;
        float a0[] = {-1.0f, asin_lkt[idx-1]};
        float a1[] = {0, asin_lkt[idx]};
        float a2[] = {1.0f, asin_lkt[idx+1]};
        float y =  signa * quadInterpolation(a0, a1, a2, fidx);
        //printf("[%s %d] idx:%d ax:%.4f a0[%.4f,%.4f] a0[%.4f,%.4f], a0[%.4f,%.4f] => %.4f\n", __func__,__LINE__,
        //    idx, ax,
        //    a0[0], a0[1], a1[0], a1[1], a2[0], a2[1], y);
        #else
            float ax_up = ax * 10000;
            int iax_up = ax_up;
            int idx = iax_up - 9000;
            float r = (float)(ax_up - iax_up);
         //   printf("[%s:%d] x:%.4f ax:%.4f idx:%d [%.4f-%.4f] rate:%.4f => %.4f\n",
         //       __func__,__LINE__,
         //       x, ax, idx, asin_lkt[idx], asin_lkt[idx+1], r, signa * lerp(asin_lkt[idx], asin_lkt[idx+1], r));
            float y = signa * bilinear(asin_lkt[idx], asin_lkt[idx+1], r);
        #endif

        return y;
    }
}

float fast_atan(float x)
{
    const static float a0[4] = {
        -0.0037002278175466974,
        1.04710252,
        -0.18627361,
        -0.07857707
    };
    const static float a1[4] = { 
        -0.03835873083805175,
        1.22213379,
        -0.47333034,
        0.0749329
    };
    const static float a2[4] = { 
        0.23748654401677938,
        0.74395186,
        -0.19253416,
        0.01897149
    };
    const static float a3[4] = {
        0.6655143527424704,
        0.31987618,
        -0.05084753,
        0.00303765
    };
    const static float a4[4] = {
        1.029536240433053,
        0.10961277,
        -0.00974906,
        0.00032041
    };

    const static float atan_high_thr     = 10.0f;
    const static float atan_higl_thr     = 5.0f;
    const static float atan_midh_thr     = fastpi;
    const static float atan_mid_thr      = fastpi_2;
    const static float atan_mids_thr     = fastpi_4;
    const static float atan_smal_thr     = 0.1;

    int signX = sign(x);
    float ax = abs(x);

    // https://math.stackexchange.com/questions/982838/asymptotic-approximation-of-the-arctangent/982859
    if (ax > atan_high_thr)       return (signX*(fastpi_2) - 1/x);
    // for small x
    else if (ax < atan_smal_thr)  return x;
    // by regression
    else if (ax < atan_mids_thr)  return signX * cubicArr(ax, a0);
    // by regression
    else if (ax < atan_mid_thr)   return signX * cubicArr(ax, a1);
    // by regression
    else if (ax < atan_midh_thr)  return signX * cubicArr(ax, a2);
    // by regression
    else if (ax < atan_higl_thr)  return signX * cubicArr(ax, a3);
    else                          return signX * cubicArr(ax, a4);
} 

float fast_cos_quad2(float x)
{
    const static float c0=0.9994880721226505;
    const static float c1=-0.49574695;
    const static float c2=0.03677138;
    float x2 = x * x;
    return quad(x2, c0, c1, c2);
    //return 1 + x2 * (-0.5 + 0.041666666666666664 * x2);
}

float fast_cos(float x)
{
    float ax = abs(x);
    //if (ax < fastsmall) return x;
    int quad = fast_fmod2(ax, fastpi_2, 4, &ax);

    if      (quad == 0) return fast_cos_quad2(ax);
    else if (quad == 1) return -fast_cos_quad2(fastpi_2 - ax);
    else if (quad == 2) return -fast_cos_quad2(ax);
    else if (quad == 3) return fast_cos_quad2(fastpi_2 - ax);
    else assert(0);
}

float fast_sin(float x)
{
    log("%.6f\n", x);
    return fast_cos(fastpi_2 - x);
}

float fast_tan(float x)
{
    /* https://mae.ufl.edu/~uhk/ACCURATE-TANGENT.pdf */
    const static float t0[] = { // 0.05 to 0.8
        -0.005306908868911164,
        1.07958615,
        -0.31961611,
        0.72791356
    };
    const static float t1[] = { // 0.8 to 1.2
        -6.798523672037293,
        24.20035856,
        -26.75328616,
        10.9062448
    };
    const static float t2[] = { // 1.2 to 1.37
        -288.476741666932,
        715.84338056,
        -593.63206871,
        166.00749918
    };
    const static float t3[] = { // 1.37 to 1.45
        -4043.7026279735396,
        8896.89927632,
        -6536.19587117,
        1605.2422637
    };
    const static float t4[] = { // 1.45 to 1.472
        1513.2746348922383,
        -2142.93149953,
        762.05357123
    };
    const static float t5[] = { // 1.472 to 1.571
       8.23809275e+00, 8.32297410e+00, 8.40959713e+00, 8.49801630e+00,
       8.58828831e+00, 8.68047230e+00, 8.77462995e+00, 8.87082562e+00,
       8.96912650e+00, 9.06960275e+00, 9.17232772e+00, 9.27737805e+00,
       9.38483395e+00, 9.49477931e+00, 9.60730201e+00, 9.72249410e+00,
       9.84045207e+00, 9.96127709e+00, 1.00850754e+01, 1.02119584e+01,
       1.03420433e+01, 1.04754533e+01, 1.06123178e+01, 1.07527733e+01,
       1.08969634e+01, 1.10450395e+01, 1.11971613e+01, 1.13534974e+01,
       1.15142258e+01, 1.16795348e+01, 1.18496236e+01, 1.20247029e+01,
       1.22049964e+01, 1.23907409e+01, 1.25821881e+01, 1.27796052e+01,
       1.29832767e+01, 1.31935050e+01, 1.34106127e+01, 1.36349437e+01,
       1.38668654e+01, 1.41067703e+01, 1.43550786e+01, 1.46122405e+01,
       1.48787389e+01, 1.51550926e+01, 1.54418593e+01, 1.57396399e+01,
       1.60490821e+01, 1.63708858e+01, 1.67058076e+01, 1.70546676e+01,
       1.74183553e+01, 1.77978378e+01, 1.81941682e+01, 1.86084950e+01,
       1.90420739e+01, 1.94962800e+01, 1.99726227e+01, 2.04727622e+01,
       2.09985289e+01, 2.15519462e+01, 2.21352559e+01, 2.27509490e+01,
       2.34018014e+01, 2.40909153e+01, 2.48217690e+01, 2.55982756e+01,
       2.64248532e+01, 2.73065087e+01, 2.82489401e+01, 2.92586589e+01,
       3.03431416e+01, 3.15110147e+01, 3.27722851e+01, 3.41386275e+01,
       3.56237468e+01, 3.72438401e+01, 3.90181892e+01, 4.09699325e+01,
       4.31270796e+01, 4.55238646e+01, 4.82025764e+01, 5.12160763e+01,
       5.46313220e+01, 5.85344018e+01, 6.30378929e+01, 6.82918980e+01,
       7.45011028e+01, 8.19520672e+01, 9.10587111e+01, 1.02441914e+02,
       1.17077345e+02, 1.36591117e+02, 1.63910235e+02, 2.04888709e+02,
       2.73185895e+02, 4.09779859e+02, 8.19560938e+02, 1.63312394e+16
   };
    const static float tan0_th = 0.8;
    const static float tan1_th = 1.2;
    const static float tan2_th = 1.37;
    const static float tan3_th = 1.45;
    const static float tan4_th = 1.472;

    float _x;
    int _ix, _quad, x2;

    int signX = sign(x);
    float ax = abs(x);

    if (ax < fastsmall)
        return x;
    if (ax > fastpi_2) {
        _quad = fast_fmod2(ax, fastpi_2, 2, &ax);
        if (signX >= 0) { // > 0
            if (_quad == 1) {
                ax = fastpi_2 - ax;
                signX = -1;
            } else signX = 1;
        } else {  // < 0
            if (_quad == 0) {}
            else {
                ax = fastpi_2 - ax;
                signX = 1;
            }
                        printf("MOD>> %.4f => %.4f Q[%d] => %s%.4f\n",
                x,ax,_quad,signX>=0?"+":"-",ax);
        }
        if (ax < fastsmall) {
            return signX * ax;
        }
    }
    if (ax < tan0_th)
        return signX * cubicArr(ax, t0);
    else if (ax < tan1_th)
        return signX * cubicArr(ax, t1);
    else if (ax < tan2_th)
        return signX * cubicArr(ax, t2);
    else if (ax < tan3_th)
        return signX * cubicArr(ax, t3);
    else if (ax < tan4_th)
        return signX * quadArr(ax, t4);
    else {
        // 1.471 to 1.571
        float ax_up = ax * 1000;
        int iax_up = ax_up;
        int idx = iax_up - 1472;
        float r = ax_up - iax_up;
        //printf(">>>%.3f=>[%.3f]Q[%d] %.4f %.4f rate:%.4f => %.4f\n",
        //    x, ax, _quad, t5[idx], t5[idx+1], r, signX * lerp(t5[idx], t5[idx+1], r));
        return signX * lerp(t5[idx], t5[idx+1], r);
    }
}


float fast_asin(float x)
{
  float negate = x < 0;
  float ax = abs(x);
  float ret = -0.0187293;
  ret *= ax;
  ret += 0.0742610;
  ret *= ax;
  ret -= 0.2121144;
  ret *= ax;
  ret += 1.5707288;
  ret = fastpi * 0.5 - sqrt(1.0 - ax) * ret;
  return ret - 2 * negate * ret;
}

//https://stackoverflow.com/questions/3380628/fast-arc-cos-algorithm
float fast_acos(float x)
{
  #if 0
  float negate = x < 0;
  float ax = abs(x);
  float ret = -0.0187293;
  ret = ret * ax;
  ret = ret + 0.0742610;
  ret = ret * ax;
  ret = ret - 0.2121144;
  ret = ret * ax;
  ret = ret + 1.5707288;
  ret = ret * sqrt(1.0-ax);
  ret = ret - 2 * negate * ret;
  return negate * 3.14159265358979 + ret;
  
    static const float C  = 0.10501094f;
    float r, s, t, u;
    t = (x < 0) ? (-x) : x;  // handle negative arguments
    u = 1.0f - t;
    s = sqrtf (u + u);
    r = C * u * s + s;  // or fmaf (C * u, s, s) if FMA support in hardware
    if (x < 0) r = fastpi - r;  // handle negative arguments
    return r;
  #endif
  return fastpi_2 - fast_asin(x);
}



#define MATH_OPS(x) (double (*)(double))(x)
#define OPS_NUM (6)
int app(int argc, char **argv)
{
    float b = atof(argv[2]);
    int range = atoi(argv[3]);
    double (*math_ops[OPS_NUM])(double) = { MATH_OPS(atan), MATH_OPS(sin), MATH_OPS(cos), MATH_OPS(tan), MATH_OPS(acos), MATH_OPS(asin)};
    float (*fast_math[OPS_NUM])(float) = {fast_atan, fast_sin, fast_cos, fast_tan, fast_acos, fast_asin};
    const char *metstr[] = {"atan", "sin", "cos", "tan", "acos", "asin"};
    unsigned int met = atoi(argv[4]);
    assert(met < OPS_NUM+1);

    float a = 0.0;
    if (strcmp(argv[1], "-0")==0) {
        for (int i = 0; i < range; i++) {
            a = math_ops[met](b);
        }
    } else {
        for (int i = 0; i < range; i++) {
            a = fast_math[met](b);
        }
    }
    printf("selected %s input:%.4f\n", metstr[met], b);
    printf("retval(%.4f)= %.5f\n\n", b, a);

    printf("atan(%.4f) = %.5f\n", b, atan(b));
    printf("sin(%.4f) = %.5f\n", b, sin(b));
    printf("cos(%.4f) = %.5f\n", b, cos(b));
    printf("tan(%.4f) = %.5f\n", b, tan(b));
    printf("acos(%.4f) = %.5f\n", b, acos(b));
    printf("asin(%.4f) = %.5f\n", b, asin(b));
    printf("fast_atan(%.4f) = %.5f\n", b, fast_atan(b));
    printf("fast_sin(%.4f) = %.5f\n", b, fast_sin(b));
    printf("fast_cos(%.4f) = %.5f\n", b, fast_cos(b));
    printf("fast_tan(%.4f) = %.5f\n", b, fast_tan(b));
    printf("fast_acos(%.4f) = %.5f\n", b, fast_acos(b));
    printf("fast_asin(%.4f) = %.5f\n", b, fast_asin(b));
    return 0;
}

int ut_test(int argc, char **argv)
{
    float b = atof(argv[2]);
    int range = atoi(argv[3]);
    double (*math_ops[OPS_NUM])(double) = { MATH_OPS(atan), MATH_OPS(sin), MATH_OPS(cos), MATH_OPS(tan), MATH_OPS(acos), MATH_OPS(asin)};
    float (*fast_math[OPS_NUM])(float) = {fast_atan, fast_sin, fast_cos, fast_tan, fast_acos, fast_asin};
    const char *metstr[] = {"atan", " sin", " cos", " tan", "acos", "asin"};
    //unsigned int met = atoi(argv[4]);
    //assert(met < 5);

    float _max[OPS_NUM] = { 0 };
    float _min[OPS_NUM] = { 0 };
    float _max_val[OPS_NUM] = { 0 };
    float _min_val[OPS_NUM] = { 0 };
    float _sum[OPS_NUM] = { 0 };
    float _mean[OPS_NUM] = { 0 };
    float *_diff = (float *)malloc(sizeof(float)*range*OPS_NUM);
    float inc = b/range;
    float in = -b/2;
    printf("in:%f - %f\n", in, in + inc * range);
    for (int i = 0; i < range; i++) {
        for (int j = 0; j < OPS_NUM; j++) {
            float val0 = math_ops[j](in);
            float val1 = fast_math[j](in);
            float diff = absf(val0-val1);
            _diff[i*OPS_NUM + j] = diff;
            if (diff > _max[j]) {
                _max[j] = diff;
                _max_val[j] = in;
            }
            if (diff < _min[j]) {
                _min[j] = diff;
                _min_val[j] = in;
            }
            _sum[j] += diff;
        }
        in += inc;
    }
    for (int i = 0; i < OPS_NUM; i++) {
        _mean[i] = _sum[i] / range;
    }
    printf("========= unit-test acc summary ========\n\n");
    printf(" test range [%.6f --- %.6f]\n", -b/2 , b/2 );
    printf("                 math vs fast_tri\n");
    for (int i = 0; i < OPS_NUM; i++) {
       printf("%8s:: max:%.6f(%.4f) min:%.6f(%.4f) mean:%.6f\n",
        metstr[i], _max[i], _max_val[i], _min[i], _min_val[i], _mean[i]);
    }
    FILE *fp = fopen("diff.bin", "wb");
    fwrite(_diff, 1, sizeof(float)*range*OPS_NUM, fp);
    fclose(fp);
    free(_diff);
    return 0;
}

void help()
{
    printf(
        "===============\n"
        "\targc:5 => [-0(math)/else(fast_math)] [input float] [iters] [fast_ops_method]\n"
        "\targc:4 => [dummy] [range * -pi/2 to pi/2] [arr size]\n"
        );
}
int main(int argc, char **argv)
{
 
    double (*math)(double) = atan;    
    if (argc == 5)
        app(argc, argv);
    else if (argc == 4)
        ut_test(argc, argv);
    else
        help();
    return 0;
}

/* time ./app {-0} 7.2 100000000 {0}
| | math | fast math |
| atan | 2.501 |  0.526 |
| sin | 5.367 | 1.944 |
| cos | 4.626 | 1.700 |
| tan | | |
*/